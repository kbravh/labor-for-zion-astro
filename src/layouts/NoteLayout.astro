---
import type { Backlink } from '@utils/md/readAndParse';
import Backlinks from '@components/layout/Backlinks.astro';
import Layout from './Layout.astro';
import type { Frontmatter, Heading } from '@validation/md';
import TableOfContents from '@components/layout/TableOfContents.astro';
import HeadingObserver from '@components/layout/HeadingObserver.astro';
import slugify from 'slugify';
import { getLocale } from '@utils/i18n/main';
import { translations } from '@utils/i18n/translations';
import NoteHeader from '@components/layout/NoteHeader.astro';
import NoteTitle from '@components/typography/NoteTitle.astro';
import Prose from '@components/typography/Prose.astro';

interface Props {
  slug: string;
  content: string;
  frontmatter: Frontmatter;
  backlinks: Backlink[];
  headings: Heading[];
  socialImage: string;
}

const { slug, frontmatter, backlinks, content, headings, socialImage } =
  Astro.props;

const locale = getLocale(Astro.currentLocale);

const tags = frontmatter.tags?.map((tag) => ({
  name: tag,
  slug: slugify(tag, { lower: true }),
}));
---

<Layout
  title={frontmatter.title}
  description={frontmatter.description}
  {socialImage}
>
  <main class="mb-10">
    <article class="grid grid-cols-1 md:grid-cols-[1fr,_300px] gap-x-14">
      <NoteHeader>
        <NoteTitle>{frontmatter.title}</NoteTitle>
        {
          frontmatter.description && (
            <p class="text-[clamp(1rem,_5vw,_1.5rem)] font-body">
              {frontmatter.description}
            </p>
          )
        }
      </NoteHeader>

      <!-- empty spot to take up the top right corner on desktop -->
      <div></div>

      <section class="max-w-3xl">
        <div class="flex justify-between gap-4 p-4 flex-wrap">
          <time datetime={frontmatter.date.toISOString()}>
            {
              frontmatter.date.toLocaleDateString(locale, {
                dateStyle: 'medium',
              })
            }
          </time>
          {
            !!tags?.length && (
              <div class="flex gap-2">
                Tags:
                <ul>
                  {tags.map(({ name, slug }) => (
                    <li
                      class:list={[
                        'inline-block rounded-md px-2 py-1 text-xs font-bold mr-2',
                        'bg-slate-300 dark:bg-slate-800 text-slate-900 dark:text-slate-100',
                      ]}
                    >
                      <a href={`/topics/${slug}`}>{name}</a>
                    </li>
                  ))}
                </ul>
              </div>
            )
          }
        </div>
        <aside class="p-4 block md:hidden">
          <TableOfContents {headings} />
        </aside>
        <!-- used for scripture verses -->
        <slot />
        <Prose id="article-body" set:html={content} />
      </section>

      <section class="pr-4">
        <div class="sticky top-4 flex flex-col gap-5">
          <aside class="hidden md:block">
            <TableOfContents {headings} />
          </aside>
          {
            !!backlinks.length && (
              <aside>
                <Backlinks backlinks={backlinks} />
              </aside>
            )
          }
        </div>
      </section>
    </article>
  </main>
  <hit-counter
    data-slug={slug}
    data-display-text={translations[locale].ui.views}></hit-counter>
  <HeadingObserver />
</Layout>
