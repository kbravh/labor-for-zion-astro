---
import {readFileSync} from 'fs';
import {
  getSlugFromFilepath,
  notePaths,
  getNoteTopics,
} from '../../utils/mdUtils';
import {Frontmatter} from '../../validation/md';
import matter from 'gray-matter';
import Layout from '../../layouts/Layout.astro';
import PageTitle from '../../components/PageTitle.astro';
import Grid from '../../components/Grid.astro';
import MainWrapper from '../../components/MainWrapper.astro';
import Link from '../../components/Link.astro';
import ArticleCard from '../../components/ArticleCard.astro';

const {slug} = Astro.params;
if (!slug) {
  throw new Error('No slug provided');
}

interface PostListing {
  slug: string;
  frontmatter: Frontmatter;
}

const posts: PostListing[] = [];
const {slugToTopic} = await getNoteTopics();
const topic = slugToTopic[slug];
if (!topic) {
  Astro.redirect('/404');
}

// Loop through all articles and extract slug and frontmatter
for (const articlePath of notePaths) {
  const source = readFileSync(articlePath, 'utf-8');
  const frontmatter = matter(source).data;
  const parsedFrontmatter = Frontmatter.parse(frontmatter);
  if (parsedFrontmatter.tags?.includes(topic)) {
    posts.push({
      frontmatter: parsedFrontmatter,
      slug: getSlugFromFilepath(articlePath),
    });
  }
}

// sort posts by written at date, recent to old
posts.sort(
  (a, b) =>
    new Date(b.frontmatter.date).getTime() -
    new Date(a.frontmatter.date).getTime()
);

export const getStaticPaths = async () => {
  const {slugToTopic} = await getNoteTopics();
  return Object.keys(slugToTopic).map(slug => ({params: {slug}}));
};
---

<Layout title="Notes">
  <div class="flex flex-col items-center flex-grow mb-10">
    <PageTitle title={`Notes about: ${topic}`} />
    <MainWrapper>
      <Grid>
        {
          posts.map(post => (
            <Link href={`/notes/${post.slug}`}>
              <ArticleCard>
                <div>
                  <h2 class="text-slate-700 font-semibold text-lg">
                    {post.frontmatter.title}
                  </h2>
                  <p class="text-slate-700 text-md">
                    {post.frontmatter.description}
                  </p>
                </div>
                <span class="text-slate-600 self-end">
                  {post.frontmatter.date.toLocaleDateString('en-US', {
                    dateStyle: 'medium',
                  })}
                </span>
              </ArticleCard>
            </Link>
          ))
        }
      </Grid>
    </MainWrapper>
  </div>
</Layout>
